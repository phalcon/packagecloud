# This file is part of the Phalcon Builder.
#
# (c) Phalcon Team <team@phalconphp.com>
#
# For the full copyright and license information, please view
# the LICENSE file that was distributed with this source code.
#
# If you did not receive a copy of the license it is available
# through the world-wide-web at the following url:
# https://license.phalconphp.com
#
# If you did not receive a copy of the license and are unable to
# obtain it through the world-wide-web, please send an email
# to license@phalconphp.com so we can send you a copy immediately.

dist: trusty

services:
    - docker

language: generic

git:
  depth: 1

cache:
  apt: true
  timeout: 604800
  directories:
    - ${HOME}/.cache/re2c
    - ${HOME}/.cache/php
    - ${HOME}/.cache/zephir

env:
  # The `BUILDTAB' variable contains descriptive information about the packages
  # the CI can build.  This variable is only read by programs, and not written;
  # it is the duty of the maintainer to properly create and maintain this
  # variable.  The order of records in `BUILDTAB' is important because build
  # programs sequentially iterate through `BUILDTAB' doing their thing.
  #
  # Each build in this matrix is described on a separate line in a format:
  #     - BUILDTAB="<OS> <DIST> <PACKAGE> <CLONE_BRANCH> <PHP_VERSION> \
  #                 <PACKAGECLOUD_REPO> <REPO_VENDOR>"
  # Fields on each line are separated by tabs or spaces.
  # Lines starting with '#' are comments.  Blank lines are ignored.
  matrix:
    # stable - ubuntu
    - BUILDTAB="ubuntu trusty deb v3.4.3 5.5 stable -"
    - BUILDTAB="ubuntu trusty deb v3.4.3 5.6 stable -"
    - BUILDTAB="ubuntu trusty deb v3.4.3 7.0 stable -"
    - BUILDTAB="ubuntu trusty deb v3.4.3 7.1 stable -"
    - BUILDTAB="ubuntu trusty deb v3.4.3 7.2 stable -"
    - BUILDTAB="ubuntu xenial deb v3.4.3 7.0 stable -"
    - BUILDTAB="ubuntu xenial deb v3.4.3 7.1 stable -"
    - BUILDTAB="ubuntu xenial deb v3.4.3 7.2 stable -"
    - BUILDTAB="ubuntu bionic deb v3.4.3 7.0 stable -"
    - BUILDTAB="ubuntu bionic deb v3.4.3 7.1 stable -"
    - BUILDTAB="ubuntu bionic deb v3.4.3 7.2 stable -"

    # stable - debian
    - BUILDTAB="debian jessie deb v3.4.3 5.6 stable -"
    - BUILDTAB="debian jessie deb v3.4.3 7.0 stable -"
    - BUILDTAB="debian jessie deb v3.4.3 7.1 stable -"
    - BUILDTAB="debian jessie deb v3.4.3 7.2 stable -"
    - BUILDTAB="debian stretch deb v3.4.3 7.0 stable -"
    - BUILDTAB="debian stretch deb v3.4.3 7.1 stable -"
    - BUILDTAB="debian stretch deb v3.4.3 7.2 stable -"

    # stable - centos
    - BUILDTAB="el 7 rpm v3.4.3 5.5 stable ius"
    - BUILDTAB="el 7 rpm v3.4.3 5.6 stable ius"
    - BUILDTAB="el 7 rpm v3.4.3 7.0 stable ius"
    - BUILDTAB="el 7 rpm v3.4.3 7.1 stable ius"
    - BUILDTAB="el 7 rpm v3.4.3 7.2 stable ius"

    # mainline - ubuntu
    - BUILDTAB="ubuntu trusty deb v4.0.0-alpha.2 7.2 mainline -"
    - BUILDTAB="ubuntu trusty deb v4.0.0-alpha.2 7.3 mainline -"
    - BUILDTAB="ubuntu xenial deb v4.0.0-alpha.2 7.2 mainline -"
    - BUILDTAB="ubuntu xenial deb v4.0.0-alpha.2 7.3 mainline -"
    - BUILDTAB="ubuntu bionic deb v4.0.0-alpha.2 7.2 mainline -"
    - BUILDTAB="ubuntu bionic deb v4.0.0-alpha.2 7.3 mainline -"

    # mainline - debian
    - BUILDTAB="debian jessie deb v4.0.0-alpha.2 7.2 mainline -"
    - BUILDTAB="debian jessie deb v4.0.0-alpha.2 7.3 mainline -"
    - BUILDTAB="debian stretch deb v4.0.0-alpha.2 7.2 mainline -"
    - BUILDTAB="debian stretch deb v4.0.0-alpha.2 7.3 mainline -"

    # mainline - centos
    - BUILDTAB="el 7 rpm v4.0.0-alpha.2 7.2 mainline ius"
    - BUILDTAB="el 7 rpm v4.0.0-alpha.2 7.3 mainline ius"

    # nightly - ubuntu
    - BUILDTAB="ubuntu trusty deb 4.0.x 7.2 nightly -"
    - BUILDTAB="ubuntu trusty deb 4.0.x 7.3 nightly -"
    - BUILDTAB="ubuntu xenial deb 4.0.x 7.2 nightly -"
    - BUILDTAB="ubuntu xenial deb 4.0.x 7.3 nightly -"
    - BUILDTAB="ubuntu bionic deb 4.0.x 7.2 nightly -"
    - BUILDTAB="ubuntu bionic deb 4.0.x 7.3 nightly -"

    # nightly - debian
    - BUILDTAB="debian jessie deb 4.0.x 7.2 nightly -"
    - BUILDTAB="debian jessie deb 4.0.x 7.3 nightly -"
    - BUILDTAB="debian stretch deb 4.0.x 7.2 nightly -"
    - BUILDTAB="debian stretch deb 4.0.x 7.3 nightly -"

    # nightly - centos
    - BUILDTAB="el 7 rpm 4.0.x 7.2 nightly ius"

matrix:
  fast_finish: true
  allow_failures:
    - env: BUILDTAB="ubuntu trusty deb 4.0.x 7.2 nightly -"
    - env: BUILDTAB="ubuntu trusty deb 4.0.x 7.3 nightly -"
    - env: BUILDTAB="ubuntu xenial deb 4.0.x 7.2 nightly -"
    - env: BUILDTAB="ubuntu xenial deb 4.0.x 7.3 nightly -"
    - env: BUILDTAB="ubuntu bionic deb 4.0.x 7.2 nightly -"
    - env: BUILDTAB="ubuntu bionic deb 4.0.x 7.3 nightly -"
    - env: BUILDTAB="debian jessie deb 4.0.x 7.2 nightly -"
    - env: BUILDTAB="debian jessie deb 4.0.x 7.3 nightly -"
    - env: BUILDTAB="debian stretch deb 4.0.x 7.2 nightly -"
    - env: BUILDTAB="debian stretch deb 4.0.x 7.3 nightly -"
    - env: BUILDTAB="el 7 rpm 4.0.x 7.2 nightly ius"
    - env: BUILDTAB="el 7 rpm 4.0.x 7.3 nightly ius"

before_install:
  - source environment
  - export $(cut -d= -f1 environment)
  - source ci/export-buildtab.sh
  # Create daily builds only for nightly branch
  - if [ "${PACKAGECLOUD_REPO}${TRAVIS_EVENT_TYPE}" = "stablecron" ]; then travis_terminate 0 ; fi
  - if [ "${PACKAGECLOUD_REPO}${TRAVIS_EVENT_TYPE}" = "mainlinecron" ]; then travis_terminate 0 ; fi
  - if [ $OS != "el" ]; then ./ci/prepare-debian.sh; fi
  - if [ $OS = "el" ]; then ./ci/prepare-rpm.sh; fi
  - if [ $REPO_VENDOR == "-" ]; then unset REPO_VENDOR; fi

install:
  - ./ci/install-php.sh || travis_terminate 1
  - source ./ci/setup-build.sh
  - ./ci/install-re2c.sh || travis_terminate 1
  - ./ci/install-zephir-parser.sh || travis_terminate 1
  - ./ci/install-zephir.sh || travis_terminate 1

before_script:
  - git clone -b $CLONE_BRANCH --depth 1 -q $PRODUCT_GIT $SOURCEDIR 2>/dev/null
  - ./ci/regenerate-build.sh || travis_terminate 1

script:
  - make -f .travis.mk ${TARGET} || travis_terminate 1

before_deploy:
  - ls -l build/

deploy:
  - provider: packagecloud
    username: "${PACKAGECLOUD_USER}"
    repository: "${PACKAGECLOUD_REPO}"
    token: "${PACKAGECLOUD_TOKEN}"
    dist: "${OS}/${DIST}"
    package_glob: build/*.{rpm,deb,dsc}
    skip_cleanup: true
    on:
      branch: "master"
      # all_branches: true
      condition: -n "${OS}" && -n "${DIST}" && -n "${PACKAGECLOUD_TOKEN}"

notifications:
    email: false
