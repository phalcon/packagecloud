# This file is part of the Phalcon.
#
# (c) Phalcon Team <team@phalconphp.com>
#
# For the full copyright and license information, please view
# the LICENSE.txt file that was distributed with this source code.
#
# If you did not receive a copy of the license it is available
# through the world-wide-web at the following url:
# https://license.phalconphp.com
#
# If you did not receive a copy of the license and are unable to
# obtain it through the world-wide-web, please send an email
# to license@phalconphp.com so we can send you a copy immediately.

dist: trusty

services:
    - docker

language: php

php:
    - 7.2

git:
  depth: 1

env:
    global:
        - PATH="$HOME/bin:$PATH"
        - PRODUCT=php-phalcon
        - PACKAGECLOUD_USER=phalcon
        - PACKAGECLOUD_REPO=stable
        - DOCKER_REPO=phalconphp/build
        - SOURCEDIR=$TRAVIS_BUILD_DIR/cphalcon
        - ZEPHIR_VERSION=0.11.8
        - ZEPHIR_PARSER_VERSION=v1.1.4
        - ZEND_BACKEND="--backend=ZendEngine3"
        - STABLE_BRANCH=v4.0.0-alpha1
        - NIGHTLY_BRANCH=4.0.x
        - STABLE_BUILD_VERSION=1
        - NIGHTLY_BUILD_VERSION=$TRAVIS_BUILD_NUMBER
        - TARGET=package
        - RE2C_VERSION="1.1.1"

    matrix:
        - OS=el DIST=7 PACKAGE=rpm CLONE_BRANCH=$STABLE_BRANCH REPO_VENDOR=ius
        - OS=ubuntu DIST=trusty PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH
        - OS=ubuntu DIST=trusty PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH PHP_VERSION=7.2
        - OS=ubuntu DIST=xenial PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH
        - OS=ubuntu DIST=xenial PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH PHP_VERSION=7.2
        - OS=ubuntu DIST=bionic PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH
        - OS=ubuntu DIST=bionic PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH PHP_VERSION=7.2
        - OS=debian DIST=jessie PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH
        - OS=debian DIST=jessie PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH PHP_VERSION=7.2
        - OS=debian DIST=stretch PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH
        - OS=debian DIST=stretch PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH PHP_VERSION=7.2
        - OS=el DIST=7 PACKAGE=rpm CLONE_BRANCH=$NIGHTLY_BRANCH REPO_VENDOR=ius
        - OS=ubuntu DIST=trusty PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
        - OS=ubuntu DIST=trusty PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH PHP_VERSION=7.2
        - OS=ubuntu DIST=xenial PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
        - OS=ubuntu DIST=xenial PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH PHP_VERSION=7.2
        - OS=ubuntu DIST=bionic PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
        - OS=ubuntu DIST=bionic PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH PHP_VERSION=7.2
        - OS=debian DIST=jessie PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
        - OS=debian DIST=jessie PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH PHP_VERSION=7.2
        - OS=debian DIST=stretch PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
        - OS=debian DIST=stretch PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH PHP_VERSION=7.2

matrix:
    fast_finish: true
    allow_failures:
        - env: OS=el DIST=7 PACKAGE=rpm CLONE_BRANCH=$NIGHTLY_BRANCH REPO_VENDOR=ius
        - env: OS=ubuntu DIST=trusty PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
        - env: OS=ubuntu DIST=trusty PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH PHP_VERSION=7.2
        - env: OS=ubuntu DIST=xenial PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
        - env: OS=ubuntu DIST=xenial PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH PHP_VERSION=7.2
        - env: OS=ubuntu DIST=bionic PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
        - env: OS=ubuntu DIST=bionic PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH PHP_VERSION=7.2
        - env: OS=debian DIST=jessie PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
        - env: OS=debian DIST=jessie PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH PHP_VERSION=7.2
        - env: OS=debian DIST=stretch PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
        - env: OS=debian DIST=stretch PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH PHP_VERSION=7.2
    exclude:
        - env: OS=ubuntu DIST=trusty PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH
          php: 7.2
        - env: OS=ubuntu DIST=trusty PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
          php: 7.2
        - env: OS=ubuntu DIST=xenial PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH
          php: 7.2
        - env: OS=ubuntu DIST=xenial PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
          php: 7.2
        - env: OS=ubuntu DIST=bionic PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH
          php: 7.2
        - env: OS=ubuntu DIST=bionic PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
          php: 7.2
        - env: OS=debian DIST=jessie PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH
          php: 7.2
        - env: OS=debian DIST=jessie PACKAGE=deb CLONE_BRANCH=$NIGHTLY_BRANCH
          php: 7.2
        - env: OS=debian DIST=stretch PACKAGE=deb CLONE_BRANCH=$STABLE_BRANCH
          php: 7.2

before_install:
    - export PHP_MAJOR_VERSION="$(echo $TRAVIS_PHP_VERSION | cut -d '.' -f 1)"
    - if [ $OS != "el" ]; then bash ${TRAVIS_BUILD_DIR}/ci/prepare_debian.sh; fi
    - phpenv config-rm xdebug.ini || true

install:
    - |
        if [ "${CLONE_BRANCH}" = "${NIGHTLY_BRANCH}" ]; then
            bash ${TRAVIS_BUILD_DIR}/ci/install-re2c.sh
            bash ${TRAVIS_BUILD_DIR}/ci/install_zephir_parser.sh
            bash ${TRAVIS_BUILD_DIR}/ci/zephir.sh
        fi

before_script:
    - git clone --branch $CLONE_BRANCH --single-branch --depth 1 https://github.com/phalcon/cphalcon.git $SOURCEDIR
    - if [ "${CLONE_BRANCH}" == "${NIGHTLY_BRANCH}" ]; then bash ${TRAVIS_BUILD_DIR}/ci/regenerate_build.sh; fi

script:
    - cd ${TRAVIS_BUILD_DIR}; make -f .travis.mk ${TARGET}

before_deploy:
    - if [ "${CLONE_BRANCH}" = "${NIGHTLY_BRANCH}" ]; then export PACKAGECLOUD_REPO=nightly; fi
    - ls -l build/

deploy:
    - provider: packagecloud
      username: "${PACKAGECLOUD_USER}"
      repository: "${PACKAGECLOUD_REPO}"
      token: "${PACKAGECLOUD_TOKEN}"
      dist: "${OS}/${DIST}"
      package_glob: build/*.{rpm,deb,dsc}
      skip_cleanup: true
      on:
          branch: "master"
          condition: -n "${OS}" && -n "${DIST}" && -n "${PACKAGECLOUD_TOKEN}"

notifications:
    email:
        recipients:
            - build@phalconphp.com
        on_success: change
        on_failure: always
