name: First attempt

on:
  push

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: "ubuntu"
            dist: "trusty"
            package: "deb"
            branch: "v4.1.2"
            php: 7.3
            packagecloud_repo: "stable"

          - os: "ubuntu"
            dist: "xenial"
            package: "deb"
            branch: "v4.1.2"
            php: 7.3
            packagecloud_repo: "stable"

          - os: "ubuntu"
            dist: "xenial"
            package: "deb"
            branch: "v4.1.2"
            php: 7.4
            packagecloud_repo: "stable"

    runs-on: ubuntu-18.04

    env:
      OS: ${{ matrix.os }}
      DIST: ${{ matrix.dist }}
      PACKAGE: ${{ matrix.package }}
      CLONE_BRANCH: ${{ matrix.branch }}
      PHP_VERSION: ${{ matrix.php }}
      PACKAGECLOUD_REPO: ${{ matrix.packagecloud_repo }}

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 1

      - name: Before install
        run: |
          source environment
          export $(cat environment | grep -v "^#\|^$" | cut -d= -f1)
#          source ci/export-buildtab.sh

      - name: Install
        run: |
          ./ci/install-php.sh
          source ./ci/setup-build.sh
          ./ci/install-re2c.sh
          ./ci/install-zephir-parser.sh
          ./ci/install-zephir.sh

      - run: ./ci/regenerate-build.sh

      - run: make -f .travis.mk ${TARGET}
